const http = require('http');

/**
 * å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜
 *
 * å¼ºç¼“å­˜ï¼šæµè§ˆå™¨åœ¨ç¼“å­˜ä¸­ç›´æŽ¥è¯»å–èµ„æºï¼Œä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚
 * åå•†ç¼“å­˜ï¼šæµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ ¹æ®èµ„æºæ˜¯å¦ä¿®æ”¹å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜ã€‚
 */

// å¼ºç¼“å­˜ç¤ºä¾‹ï¼šé€šè¿‡ Cache-Control æˆ– Expires å®žçŽ°
// Cache-Control: max-age=3600 è¡¨ç¤ºèµ„æºåœ¨ 3600 ç§’å†…æœ‰æ•ˆ
// Expires: æŒ‡å®šèµ„æºçš„è¿‡æœŸæ—¶é—´ï¼ˆHTTP/1.0ï¼Œå·²è¢« Cache-Control æ›¿ä»£ï¼‰
// ðŸ”¹ å®žçŽ°æ–¹å¼
// ç”± å“åº”å¤´ï¼ˆResponse Headerï¼‰ æŽ§åˆ¶ï¼š
// Cache-Controlï¼ˆHTTP/1.1ï¼‰
// å¸¸ç”¨æŒ‡ä»¤ï¼š
// max-age=3600ï¼šèµ„æºåœ¨ 3600 ç§’ï¼ˆ1å°æ—¶ï¼‰å†…æœ‰æ•ˆï¼Œæµè§ˆå™¨ç›´æŽ¥ä½¿ç”¨ç¼“å­˜
// publicï¼šè¡¨ç¤ºè¯¥å“åº”å¯ä»¥è¢«ä»»ä½•ç¼“å­˜åŒºç¼“å­˜
// privateï¼šåªå…è®¸å®¢æˆ·ç«¯ç¼“å­˜
// no-cacheï¼šä»ä¼šè¯·æ±‚æœåŠ¡å™¨ï¼ˆè¿›å…¥åå•†ç¼“å­˜æµç¨‹ï¼‰
// no-storeï¼šå®Œå…¨ç¦æ­¢ç¼“å­˜
// Expiresï¼ˆHTTP/1.0ï¼‰
// è®¾ç½®ä¸€ä¸ªç»å¯¹è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚ï¼šExpires: Wed, 21 Oct 2025 07:28:00 GMT
// âš ï¸ å®ƒå·²è¢« Cache-Control æ›¿ä»£ï¼Œä½†è€ç‰ˆæœ¬æµè§ˆå™¨ä»åœ¨ä½¿ç”¨

// ðŸ”¹ æµç¨‹
// æµè§ˆå™¨è®¿é—®èµ„æº
// å“åº”ä¸­å¸¦æœ‰ Cache-Control: max-age=3600
// åœ¨ 1 å°æ—¶å†…å†æ¬¡è®¿é—®ç›¸åŒèµ„æºï¼š
// æµè§ˆå™¨ç›´æŽ¥ä»Ž æœ¬åœ°ç¼“å­˜è¯»å–
// ä¸å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨

// ðŸ”¹ å¼ºç¼“å­˜çš„è¡¨çŽ°
// æµè§ˆå™¨æŽ§åˆ¶å° Network é¢æ¿ä¸­ï¼Œè¯¥èµ„æºçŠ¶æ€æ˜¯ 200 (from disk cache) æˆ– 200 (from memory cache)
// ä¸ä¼šå‘èµ· HTTP è¯·æ±‚


// äºŒã€åå•†ç¼“å­˜

// åå•†ç¼“å­˜ç¤ºä¾‹ï¼šé€šè¿‡ ETag æˆ– Last-Modified å®žçŽ°
// æµè§ˆå™¨å‘é€è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ ¹æ®ç‰¹å®šæ¡ä»¶åˆ¤æ–­æ˜¯å¦è¿”å›žæ–°èµ„æºæˆ–è®©æµè§ˆå™¨ä½¿ç”¨ç¼“å­˜ã€‚
// ETag: èµ„æºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œèµ„æºå˜åŒ–æ—¶ ETag ä¹Ÿä¼šå˜åŒ–
// Last-Modified: èµ„æºçš„æœ€åŽä¿®æ”¹æ—¶é—´
// ðŸ”¹ å®žçŽ°æ–¹å¼
// ç”±ä»¥ä¸‹ è¯·æ±‚å¤´ + å“åº”å¤´ æŽ§åˆ¶ï¼š

// 1. åŸºäºŽä¿®æ”¹æ—¶é—´çš„åå•†ç¼“å­˜
// é¦–æ¬¡å“åº”æ—¶æœåŠ¡å™¨è¿”å›žï¼š
// Last-Modified: Tue, 21 May 2024 08:00:00 GMT
// æµè§ˆå™¨ä¸‹æ¬¡è¯·æ±‚æ—¶ä¼šå¸¦ä¸Šï¼š
// If-Modified-Since: Tue, 21 May 2024 08:00:00 GMT
// æœåŠ¡å™¨æ¯”è¾ƒèµ„æºä¿®æ”¹æ—¶é—´ï¼š
// æ²¡æœ‰ä¿®æ”¹ï¼šè¿”å›ž 304 Not Modified
// ä¿®æ”¹äº†ï¼šè¿”å›ž 200 OK + æ–°èµ„æºå†…å®¹


// 2. åŸºäºŽå†…å®¹æ‘˜è¦ï¼ˆå“ˆå¸Œï¼‰çš„åå•†ç¼“å­˜
//     é¦–æ¬¡å“åº”æ—¶æœåŠ¡å™¨è¿”å›žï¼š
          // ETag: "abc123"
//     æµè§ˆå™¨ä¸‹æ¬¡è¯·æ±‚æ—¶ä¼šå¸¦ä¸Šï¼š
//          If-None-Match: "abc123"

// æœåŠ¡å™¨å¯¹æ¯”å†…å®¹å“ˆå¸Œï¼š
// ä¸€è‡´ï¼šè¿”å›ž 304
// ä¸ä¸€è‡´ï¼šè¿”å›ž 200 + æ–°èµ„æº


// âœ… å¯¹æ¯”æ€»ç»“ï¼šå¼ºç¼“å­˜ vs åå•†ç¼“å­˜
// | ç‰¹æ€§     | å¼ºç¼“å­˜ï¼ˆCache-Control/Expiresï¼‰ | åå•†ç¼“å­˜ï¼ˆETag / Last-Modifiedï¼‰ |
// | ------ | -------------------------- | -------------------------- |
// | æ˜¯å¦å‘é€è¯·æ±‚ | âŒ ä¸å‘é€                      | âœ… å‘é€                       |
// | èµ„æºä½¿ç”¨ä½ç½® | æœ¬åœ°ç¼“å­˜                       | æœ¬åœ°ç¼“å­˜ï¼ˆéœ€æœåŠ¡å™¨ç¡®è®¤ï¼‰               |
// | è¿”å›žçŠ¶æ€ç   | 200 (from cache)           | 304 Not Modified           |
// | æŽ§åˆ¶å­—æ®µ   | `Cache-Control`, `Expires` | `ETag`, `Last-Modified`    |
// | æ€§èƒ½     | âœ… æ›´å¿«ï¼ˆé›¶è¯·æ±‚ï¼‰                  | è¾ƒå¿«ï¼ˆå°‘é‡è¯·æ±‚ï¼Œæ— èµ„æºè¿”å›žï¼‰             |

// ç¤ºä¾‹ä»£ç ï¼šæ¨¡æ‹Ÿå¼ºç¼“å­˜å’Œåå•†ç¼“å­˜çš„é€»è¾‘

const server = http.createServer((req, res) => {
  const url = req.url;
  const now = new Date();
  const lastModified = new Date(now.getTime() - 10000); // 10 ç§’å‰ä¿®æ”¹
  const etag = '12345'; // æ¨¡æ‹Ÿçš„ ETag å€¼

  if (url === '/strong-cache') {
    // å¼ºç¼“å­˜
    res.setHeader('Cache-Control', 'max-age=30'); // ç¼“å­˜ 30 ç§’
    res.end('This is strong cache response');
  } else if (url === '/negotiation-cache') {
    // åå•†ç¼“å­˜
    const ifModifiedSince = req.headers['if-modified-since'];
    const ifNoneMatch = req.headers['if-none-match'];

    if (ifNoneMatch === etag) {
      res.writeHead(304); // èµ„æºæœªä¿®æ”¹
      res.end();
    } else if (ifModifiedSince && new Date(ifModifiedSince) >= lastModified) {
      res.writeHead(304); // èµ„æºæœªä¿®æ”¹
      res.end();
    } else {
      res.setHeader('Last-Modified', lastModified.toUTCString());
      res.setHeader('ETag', etag);
      res.end('This is negotiation cache response');
    }
  } else {
    res.end('Hello, world!');
  }
});

server.listen(3000, () => {
  console.log('Server is running at http://localhost:3000');
});